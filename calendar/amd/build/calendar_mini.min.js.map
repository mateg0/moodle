{"version":3,"sources":["../src/calendar_mini.js"],"names":["define","$","CalendarSelectors","CalendarEvents","CalendarViewManager","CalendarRepository","registerCalendarEventListeners","root","body","namespace","attr","on","created","reloadMonth","deleted","updated","eventMoved","e","data","is","reloadCurrentMonth","then","setEventListenerToFilterIcon","off","registerEventListeners","filterChanged","daysWithEvent","find","eventType","type","toggleClass","hidden","elements","courseSelector","selectElement","courseId","val","document","querySelector","addEventListener","toggleFilterContext","filterContext","selectCourse","style","display","getUserCourses","courses","resetSelect","forEach","course","courseOption","createElement","text","fullname","value","id","append","reloadMonthByCourseId","removeEventListener","select","allCoursesOption","innerHTML","event","target","miniCalendar","closest","parentElement","init","loadOnInit"],"mappings":"AA2BAA,OAAM,+BAAC,CACH,QADG,CAEH,yBAFG,CAGH,sBAHG,CAIH,4BAJG,CAKH,0BALG,CAAD,CAON,SACIC,CADJ,CAEIC,CAFJ,CAGIC,CAHJ,CAIIC,CAJJ,CAKIC,CALJ,CAME,IAQMC,CAAAA,CAA8B,CAAG,SAASC,CAAT,CAAe,IAC5CC,CAAAA,CAAI,CAAGP,CAAC,CAAC,MAAD,CADoC,CAE5CQ,CAAS,CAAG,IAAMF,CAAI,CAACG,IAAL,CAAU,IAAV,CAF0B,CAIhDF,CAAI,CAACG,EAAL,CAAQR,CAAc,CAACS,OAAf,CAAyBH,CAAjC,CAA4CF,CAA5C,CAAkDM,CAAlD,EACAL,CAAI,CAACG,EAAL,CAAQR,CAAc,CAACW,OAAf,CAAyBL,CAAjC,CAA4CF,CAA5C,CAAkDM,CAAlD,EACAL,CAAI,CAACG,EAAL,CAAQR,CAAc,CAACY,OAAf,CAAyBN,CAAjC,CAA4CF,CAA5C,CAAkDM,CAAlD,EACAL,CAAI,CAACG,EAAL,CAAQR,CAAc,CAACa,UAAf,CAA4BP,CAApC,CAA+CF,CAA/C,CAAqDM,CAArD,CACH,CAhBH,CAuBMA,CAAW,CAAG,SAASI,CAAT,CAAY,IACtBV,CAAAA,CAAI,CAAGU,CAAC,CAACC,IADa,CAEtBV,CAAI,CAAGP,CAAC,CAAC,MAAD,CAFc,CAGtBQ,CAAS,CAAG,IAAMF,CAAI,CAACG,IAAL,CAAU,IAAV,CAHI,CAK1B,GAAIH,CAAI,CAACY,EAAL,CAAQ,UAAR,CAAJ,CAAyB,CACrBf,CAAmB,CACdgB,kBADL,CACwBb,CADxB,EAEKc,IAFL,CAEUC,CAFV,CAIH,CALD,IAKO,CAGHd,CAAI,CAACe,GAAL,CAASpB,CAAc,CAACS,OAAf,CAAyBH,CAAlC,EACAD,CAAI,CAACe,GAAL,CAASpB,CAAc,CAACW,OAAf,CAAyBL,CAAlC,EACAD,CAAI,CAACe,GAAL,CAASpB,CAAc,CAACY,OAAf,CAAyBN,CAAlC,EACAD,CAAI,CAACe,GAAL,CAASpB,CAAc,CAACa,UAAf,CAA4BP,CAArC,CACH,CACJ,CAzCH,CA2CMe,CAAsB,CAAG,SAASjB,CAAT,CAAe,CACxCN,CAAC,CAAC,MAAD,CAAD,CAAUU,EAAV,CAAaR,CAAc,CAACsB,aAA5B,CAA2C,SAASR,CAAT,CAAYC,CAAZ,CAAkB,CACzD,GAAIQ,CAAAA,CAAa,CAAGnB,CAAI,CAACoB,IAAL,CAAUzB,CAAiB,CAAC0B,SAAlB,CAA4BV,CAAI,CAACW,IAAjC,CAAV,CAApB,CAEAH,CAAa,CAACI,WAAd,CAA0B,kBAAoBZ,CAAI,CAACW,IAAnD,CAAyD,CAACX,CAAI,CAACa,MAA/D,CACH,CAJD,EAMA,GAAItB,CAAAA,CAAS,CAAG,IAAMF,CAAI,CAACG,IAAL,CAAU,IAAV,CAAtB,CACAT,CAAC,CAAC,MAAD,CAAD,CAAUU,EAAV,CAAa,SAAWF,CAAxB,CAAmCP,CAAiB,CAAC8B,QAAlB,CAA2BC,cAA9D,CAA8E,UAAW,CACrF,GAAI1B,CAAI,CAACY,EAAL,CAAQ,UAAR,CAAJ,CAAyB,IACjBe,CAAAA,CAAa,CAAGjC,CAAC,CAAC,IAAD,CADA,CAEjBkC,CAAQ,CAAGD,CAAa,CAACE,GAAd,EAFM,CAKrBhC,CAAmB,CAACgB,kBAApB,CAAuCb,CAAvC,CAA6C4B,CAA7C,CAFiB,IAEjB,CACH,CAND,IAMO,CACHlC,CAAC,CAAC,MAAD,CAAD,CAAUsB,GAAV,CAAc,SAAWd,CAAzB,CACH,CACJ,CAVD,CAWH,CA9DH,CAgEQa,CAA4B,CAAG,UAAM,CACvCe,QAAQ,CACHC,aADL,CACmB,gCADnB,EAEKA,aAFL,CAEmB,cAFnB,EAGKC,gBAHL,CAGsB,OAHtB,CAG+BC,CAH/B,CAIH,CArEH,CAuEQA,CAAmB,CAAG,UAAW,IAC7BC,CAAAA,CAAa,CAAGJ,QAAQ,CACzBC,aADiB,CACH,uCADG,EAEjBA,aAFiB,CAEH,iCAFG,CADa,CAI7BI,CAAY,CAAGD,CAAa,CAACH,aAAd,CAA4B,sBAA5B,CAJc,CAMnC,GAAoC,MAAhC,GAAAG,CAAa,CAACE,KAAd,CAAoBC,OAAxB,CAA4C,CACxCvC,CAAkB,CACbwC,cADL,GAEKxB,IAFL,CAEU,SAACyB,CAAD,CAAa,CACfC,CAAW,CAACL,CAAD,CAAX,CAEAI,CAAO,CAACE,OAAR,CAAgB,SAAAC,CAAM,CAAI,CACtB,GAAMC,CAAAA,CAAY,CAAGb,QAAQ,CAACc,aAAT,CAAuB,QAAvB,CAArB,CACAD,CAAY,CAACE,IAAb,CAAoBH,CAAM,CAACI,QAA3B,CACAH,CAAY,CAACI,KAAb,CAAqBL,CAAM,CAACM,EAA5B,CAEAb,CAAY,CAACc,MAAb,CAAoBN,CAApB,CACH,CAND,EAQAR,CAAY,CAACH,gBAAb,CAA8B,QAA9B,CAAwCkB,CAAxC,EAEAhB,CAAa,CAACE,KAAd,CAAoBC,OAApB,CAA8B,OACjC,CAhBL,CAiBH,CAlBD,IAkBO,CACHF,CAAY,CAACgB,mBAAb,CAAiC,QAAjC,CAA2CD,CAA3C,EAEAhB,CAAa,CAACE,KAAd,CAAoBC,OAApB,CAA8B,MACjC,CACJ,CApGH,CAsGQG,CAAW,CAAG,SAACY,CAAD,CAAY,CAC5B,GAAMC,CAAAA,CAAgB,CAAGvB,QAAQ,CAACc,aAAT,CAAuB,QAAvB,CAAzB,CACAS,CAAgB,CAACR,IAAjB,CAAwB,mDAAxB,CACAQ,CAAgB,CAACN,KAAjB,CAAyB,GAAzB,CAEAK,CAAM,CAACE,SAAP,CAAmB,EAAnB,CAEAF,CAAM,CAACH,MAAP,CAAcI,CAAd,CACH,CA9GH,CAgHQH,CAAqB,CAAG,SAACK,CAAD,CAAW,IAC/B3B,CAAAA,CAAQ,CAAG2B,CAAK,CAACC,MAAN,CAAaT,KADO,CAE/BU,CAAY,CAAG3B,QAAQ,CACxBC,aADgB,CACF,oBADE,EAEhB2B,OAFgB,CAER,qBAFQ,EAGhBC,aALgC,CAOrC9D,CAAmB,CACdgB,kBADL,CACwBnB,CAAC,CAAC+D,CAAD,CADzB,CACyC7B,CADzC,EAEKd,IAFL,CAEUC,CAFV,CAIH,CA3HH,CA6HE,MAAO,CACH6C,IAAI,CAAE,cAAS5D,CAAT,CAAe6D,CAAf,CAA2B,CAC7B7D,CAAI,CAAGN,CAAC,CAACM,CAAD,CAAR,CAEAH,CAAmB,CAAC+D,IAApB,CAAyB5D,CAAzB,EACAiB,CAAsB,CAACjB,CAAD,CAAtB,CACAD,CAA8B,CAACC,CAAD,CAA9B,CAEA,GAAI6D,CAAJ,CAAgB,CAGZhE,CAAmB,CACdgB,kBADL,CACwBb,CADxB,EAEKc,IAFL,CAEUC,CAFV,CAIH,CAEJ,CAjBE,CAmBV,CA7JK,CAAN","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * This module is the highest level module for the calendar. It is\n * responsible for initialising all of the components required for\n * the calendar to run. It also coordinates the interaction between\n * components by listening for and responding to different events\n * triggered within the calendar UI.\n *\n * @module     core_calendar/calendar_mini\n * @package    core_calendar\n * @copyright  2017 Andrew Nicols <andrew@nicols.co.uk>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine([\n    'jquery',\n    'core_calendar/selectors',\n    'core_calendar/events',\n    'core_calendar/view_manager',\n    'core_calendar/repository',\n],\nfunction(\n    $,\n    CalendarSelectors,\n    CalendarEvents,\n    CalendarViewManager,\n    CalendarRepository,\n) {\n\n    /**\n     * Listen to and handle any calendar events fired by the calendar UI.\n     *\n     * @method registerCalendarEventListeners\n     * @param {object} root The calendar root element\n     */\n    var registerCalendarEventListeners = function(root) {\n        var body = $('body');\n        var namespace = '.' + root.attr('id');\n\n        body.on(CalendarEvents.created + namespace, root, reloadMonth);\n        body.on(CalendarEvents.deleted + namespace, root, reloadMonth);\n        body.on(CalendarEvents.updated + namespace, root, reloadMonth);\n        body.on(CalendarEvents.eventMoved + namespace, root, reloadMonth);\n    };\n\n    /**\n     * Reload the month view in this month.\n     *\n     * @param {EventFacade} e\n     */\n    var reloadMonth = function(e) {\n        var root = e.data;\n        var body = $('body');\n        var namespace = '.' + root.attr('id');\n\n        if (root.is(':visible')) {\n            CalendarViewManager\n                .reloadCurrentMonth(root)\n                .then(setEventListenerToFilterIcon)\n            ;\n        } else {\n            // The root has been removed.\n            // Remove all events in the namespace.\n            body.off(CalendarEvents.created + namespace);\n            body.off(CalendarEvents.deleted + namespace);\n            body.off(CalendarEvents.updated + namespace);\n            body.off(CalendarEvents.eventMoved + namespace);\n        }\n    };\n\n    var registerEventListeners = function(root) {\n        $('body').on(CalendarEvents.filterChanged, function(e, data) {\n            var daysWithEvent = root.find(CalendarSelectors.eventType[data.type]);\n\n            daysWithEvent.toggleClass('calendar_event_' + data.type, !data.hidden);\n        });\n\n        var namespace = '.' + root.attr('id');\n        $('body').on('change' + namespace, CalendarSelectors.elements.courseSelector, function() {\n            if (root.is(':visible')) {\n                var selectElement = $(this);\n                var courseId = selectElement.val();\n                var categoryId = null;\n\n                CalendarViewManager.reloadCurrentMonth(root, courseId, categoryId);\n            } else {\n                $('body').off('change' + namespace);\n            }\n        });\n    };\n\n    const setEventListenerToFilterIcon = () => {\n        document\n            .querySelector('.minicalendar-filter-by-course')\n            .querySelector('.filter-icon')\n            .addEventListener('click', toggleFilterContext);\n    };\n\n    const toggleFilterContext = (event) => {\n        const filterContext = document\n            .querySelector('section.minicalendar-filter-by-course')\n            .querySelector('div.minicalendar-filter-context');\n        const selectCourse = filterContext.querySelector('select.select-course');\n\n        if (filterContext.style.display === 'none') {\n            CalendarRepository\n                .getUserCourses()\n                .then((courses) => {\n                    resetSelect(selectCourse);\n\n                    courses.forEach(course => {\n                        const courseOption = document.createElement('option');\n                        courseOption.text = course.fullname;\n                        courseOption.value = course.id;\n\n                        selectCourse.append(courseOption);\n                    });\n\n                    selectCourse.addEventListener('change', reloadMonthByCourseId);\n\n                    filterContext.style.display = 'block';\n                });\n        } else {\n            selectCourse.removeEventListener('change', reloadMonthByCourseId);\n\n            filterContext.style.display = 'none';\n        }\n    };\n\n    const resetSelect = (select) => {\n        const allCoursesOption = document.createElement('option');\n        allCoursesOption.text = 'Все курсы';\n        allCoursesOption.value = '1';\n\n        select.innerHTML = '';\n\n        select.append(allCoursesOption);\n    };\n\n    const reloadMonthByCourseId = (event) => {\n        const courseId = event.target.value;\n        const miniCalendar = document\n            .querySelector('table.minicalendar')\n            .closest('div.calendarwrapper')\n            .parentElement;\n\n        CalendarViewManager\n            .reloadCurrentMonth($(miniCalendar), courseId)\n            .then(setEventListenerToFilterIcon)\n        ;\n    };\n\n    return {\n        init: function(root, loadOnInit) {\n            root = $(root);\n\n            CalendarViewManager.init(root);\n            registerEventListeners(root);\n            registerCalendarEventListeners(root);\n\n            if (loadOnInit) {\n                // The calendar hasn't yet loaded it's events so we\n                // should load them as soon as we've initialised.\n                CalendarViewManager\n                    .reloadCurrentMonth(root)\n                    .then(setEventListenerToFilterIcon)\n                ;\n            }\n\n        }\n    };\n});\n"],"file":"calendar_mini.min.js"}