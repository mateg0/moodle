define ("core_backup/async_backup",["jquery","core/ajax","core/str","core/notification","core/templates"],function(a,b,c,d,e){var f=900,g=1e3,h={},i=15e3,j=15e3,k=1.5,l,m,n,o,p,q,r,s=2e3;function t(a,b,c){var d=Math.round(c)+"%",e=document.querySelectorAll("[data-"+b+"id="+CSS.escape(a)+"]")[0],f=c.toFixed(2)+"%";e.setAttribute("aria-valuenow",d);e.style.width=d;e.innerHTML=f}function u(a,b,c){clearInterval(a);return setInterval(b,c)}function v(c){var f=a("#"+c+"_bar").parent().parent(),g=f.parent(),h=f.siblings(),i=h[1],j=a(i).text(),k=h[0],l=a(k).text();b.call([{methodname:"core_backup_get_async_backup_links_backup",args:{filename:l,contextid:m}}])[0].done(function(a){var b={filename:l,time:j,size:a.filesize,fileurl:a.fileurl,restoreurl:a.restoreurl};e.render("core/async_backup_progress_row",b).then(function(a,b){e.replaceNodeContents(g,a,b)}).fail(function(){d.exception(new Error("Failed to load table row"))})})}function w(c){var f=a("#"+c+"_bar").parent().parent(),g=f.parent(),h=f.siblings(),i=h[0],j=h[1],k=a(j).text();b.call([{methodname:"core_backup_get_async_backup_links_restore",args:{backupid:c,contextid:m}}])[0].done(function(b){var c=a(i).text(),f={resourcename:c,restoreurl:b.restoreurl,time:k};e.render("core/async_restore_progress_row",f).then(function(a,b){e.replaceNodeContents(g,a,b)}).fail(function(){d.exception(new Error("Failed to load table row"))})})}function x(a){var f=document.querySelectorAll("[data-restoreid="+CSS.escape(a)+"]")[0],g=f.closest("tr").children[1],h=g.innerHTML,i=document.createElement("a"),j=f.closest("td"),k=j.previousElementSibling;c.get_string("complete").then(function(a){k.innerHTML=a}).catch(function(){d.exception(new Error("Failed to load string: complete"))});e.render("core/async_copy_complete_cell",{}).then(function(a,b){e.replaceNodeContents(j,a,b)}).fail(function(){d.exception(new Error("Failed to load table cell"))});b.call([{methodname:"core_backup_get_async_backup_links_restore",args:{backupid:a,contextid:0}}])[0].done(function(a){i.setAttribute("href",a.restoreurl);i.innerHTML=h;g.innerHTML=null;g.appendChild(i)}).fail(function(){d.exception(new Error("Failed to update table row"))})}function y(e){var h=100*e.progress,i="backup",j=document.querySelectorAll("[data-"+i+"id="+CSS.escape(l)+"]")[0],k=a("#"+l+"_status"),q=a("#"+l+"_detail"),r=a("#"+l+"_button"),s;if(e.status==800){j.classList.add("bg-success");t(l,i,h);var u="async"+o+"processing";c.get_string(u,"backup").then(function(a){k.text(a)}).catch(function(){d.exception(new Error("Failed to load string: backup "+u))})}else if(e.status==f){j.classList.add("bg-danger");j.classList.remove("bg-success");t(l,i,100);var v="async"+o+"error",w="async"+o+"errordetail";s=[{key:v,component:"backup"},{key:w,component:"backup"}];c.get_strings(s).then(function(a){k.text(a[0]);q.text(a[1])}).catch(function(){d.exception(new Error("Failed to load string"))});a(".backup_progress").children("span").removeClass("backup_stage_current");a(".backup_progress").children("span").last().addClass("backup_stage_current");clearInterval(p)}else if(e.status==g){j.classList.add("bg-success");t(l,i,100);var x="async"+o+"complete";c.get_string(x,"backup").then(function(a){k.text(a)}).catch(function(){d.exception(new Error("Failed to load string: backup "+x))});if("restore"==o){b.call([{methodname:"core_backup_get_async_backup_links_restore",args:{backupid:l,contextid:m}}])[0].done(function(a){var b="async"+o+"completedetail",e="async"+o+"completebutton",f=[{key:b,component:"backup",param:a.restoreurl},{key:e,component:"backup"}];c.get_strings(f).then(function(b){q.html(b[0]);r.text(b[1]);r.attr("href",a.restoreurl)}).catch(function(){d.exception(new Error("Failed to load string"))})})}else{var y="async"+o+"completedetail",z="async"+o+"completebutton";s=[{key:y,component:"backup",param:n},{key:z,component:"backup"}];c.get_strings(s).then(function(a){q.html(a[0]);r.text(a[1]);r.attr("href",n)}).catch(function(){d.exception(new Error("Failed to load string"))})}a(".backup_progress").children("span").removeClass("backup_stage_current");a(".backup_progress").children("span").last().addClass("backup_stage_current");clearInterval(p)}}function z(a){a.forEach(function(a){var b=100*a.progress,c=a.backupid,d=a.operation,e=document.querySelectorAll("[data-"+d+"id="+CSS.escape(c)+"]")[0];if(a.status==800){e.classList.add("bg-success");t(c,d,b)}else if(a.status==f){e.classList.add("bg-danger");e.classList.add("complete");e.classList.remove("bg-success");t(c,d,100)}else if(a.status==g){e.classList.add("bg-success");e.classList.add("complete");t(c,d,100);if("backup"==d){v(c)}else{w(c)}}})}function A(a){a.forEach(function(a){var b=100*a.progress,e=a.backupid,h=a.operation,i=document.querySelectorAll("[data-"+h+"id="+CSS.escape(e)+"]")[0];if("restore"==h){var j=i.closest("tr").children[3];c.get_string("restore").then(function(a){j.innerHTML=a}).catch(function(){d.exception(new Error("Failed to load string: restore"))})}if(a.status==800){i.classList.add("bg-success");t(e,h,b)}else if(a.status==f){i.classList.add("bg-danger");i.classList.add("complete");i.classList.remove("bg-success");t(e,h,100)}else if(a.status==g&&"restore"==h){i.classList.add("bg-success");i.classList.add("complete");t(e,h,100);x(e)}})}function B(){b.call([{methodname:"core_backup_get_async_backup_progress",args:{backupids:[l],contextid:m}}],!0,!0,!1,s)[0].done(function(a){y(a[0]);j=i;p=u(p,B,i)}).fail(function(){j=j*k;p=u(p,B,j)})}function C(){var c=[],d=a(".progress").find(".progress-bar").not(".complete");d.each(function(){c.push(this.id.substring(0,32))});if(0<c.length){b.call([{methodname:"core_backup_get_async_backup_progress",args:{backupids:c,contextid:m}}],!0,!0,!1,s)[0].done(function(a){z(a);j=i;q=u(q,C,i)}).fail(function(){j=j*k;q=u(q,C,j)})}else{clearInterval(q)}}function D(){var c=[],d=a(".progress").find(".progress-bar[data-operation][data-backupid][data-restoreid]").not(".complete");d.each(function(){var a={backupid:this.dataset.backupid,restoreid:this.dataset.restoreid,operation:this.dataset.operation};c.push(a)});if(0<c.length){b.call([{methodname:"core_backup_get_copy_progress",args:{copies:c}}],!0,!0,!1,s)[0].done(function(a){A(a);j=i;r=u(r,D,i)}).fail(function(){j=j*k;r=u(r,D,j)})}else{clearInterval(r)}}h.asyncBackupAllStatus=function(a){m=a;q=setInterval(C,j)};h.asyncCopyAllStatus=function(){r=setInterval(D,j)};h.asyncBackupStatus=function(b,c,d,e){l=b;m=c;n=d;if("backup"==e){o="backup"}else{o="restore"}a(".backup_progress").children("a").removeAttr("href");p=setInterval(B,j)};return h});
//# sourceMappingURL=async_backup.min.js.map
