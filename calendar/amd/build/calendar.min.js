function _createForOfIteratorHelper(a,b){var c="undefined"!=typeof Symbol&&a[Symbol.iterator]||a["@@iterator"];if(!c){if(Array.isArray(a)||(c=_unsupportedIterableToArray(a))||b&&a&&"number"==typeof a.length){if(c)a=c;var d=0,e=function(){};return{s:e,n:function n(){if(d>=a.length)return{done:!0};return{done:!1,value:a[d++]}},e:function e(a){throw a},f:e}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var f=!0,g=!1,h;return{s:function s(){c=c.call(a)},n:function n(){var a=c.next();f=a.done;return a},e:function e(a){g=!0;h=a},f:function f(){try{if(!f&&null!=c.return)c.return()}finally{if(g)throw h}}}}function _unsupportedIterableToArray(a,b){if(!a)return;if("string"==typeof a)return _arrayLikeToArray(a,b);var c=Object.prototype.toString.call(a).slice(8,-1);if("Object"===c&&a.constructor)c=a.constructor.name;if("Map"===c||"Set"===c)return Array.from(a);if("Arguments"===c||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(c))return _arrayLikeToArray(a,b)}function _arrayLikeToArray(a,b){if(null==b||b>a.length)b=a.length;for(var c=0,d=Array(b);c<b;c++){d[c]=a[c]}return d}define ("core_calendar/calendar",["jquery","core/ajax","core/str","core/templates","core/notification","core/custom_interaction_events","core/modal_events","core/modal_factory","core_calendar/modal_event_form","core_calendar/summary_modal","core_calendar/repository","core_calendar/events","core_calendar/view_manager","core_calendar/crud","core_calendar/selectors"],function(a,b,c,d,f,g,h,i,j,k,l,m,n,o,p){var q={ROOT:"[data-region='calendar']",DAY:"[data-region='day']",NEW_EVENT_BUTTON:"[data-action='new-event-button']",DAY_CONTENT:"[data-region='day-content']",LOADING_ICON:".loading-icon",VIEW_DAY_LINK:"[data-action='view-day-link']",CALENDAR_MONTH_WRAPPER:".calendarwrapper",TODAY:".today",CELL_ADD_EVENT_BUTTON_MONTH:"div.cell-plus-add-event",CELL_ADD_EVENT_BUTTON_DAY:"div.c-d-add-event",ADD_EVENT_FORM:".add-event",ADD_EVENT_FORM_DATA:"form.add-event-form",ADD_EVENT_FORM_ADD_BUTTON:"div.add-event-add-button",ADD_EVENT_FORM_DELETE_BUTTON:"div.add-event-delete-button",EVENT_TYPES:"div.event-types",EVENT_TYPE:"div.event-type",SCHEDULE:".schedule",SCHEDULE_CONTENT:"div.schedule-content",SCHEDULE_ADD_EVENT_BUTTON:"div.add-schedule-event",SCHEDULE_LINE:"div.schedule-line",LEGEND_GROUP:".legend-group",LEGEND_GROUP_COLOR:".legend-group-color",SELECT_COURSE:"select.select-course",SELECT_GROUP:"select.select-group",SELECT_COURSE_WRAPPER:"div.event-select-course",SELECT_GROUP_WRAPPER:"div.event-select-group",BACK_BUTTON_FROM_SELECT:"div.event-back-image"},r="newEventTimestamp",s="eventType",t="eventId",u=function(b,c,e,g){var h=null,i=g.attr("data-day-timestamp");if(e){h=e.attr("data-day-timestamp")}if(!e||h!=i){d.render("core/loading",{}).then(function(a,b){g.find(q.DAY_CONTENT).addClass("hidden");d.appendNodeContents(g,a,b);if(e){e.find(q.DAY_CONTENT).addClass("hidden");d.appendNodeContents(e,a,b)}}).then(function(){return l.updateEventStartDay(c,i)}).then(function(){a("body").trigger(m.eventMoved,[c,e,g])}).always(function(){var a=g.find(q.LOADING_ICON);g.find(q.DAY_CONTENT).removeClass("hidden");d.replaceNode(a,"","");if(e){var b=e.find(q.LOADING_ICON);e.find(q.DAY_CONTENT).removeClass("hidden");d.replaceNode(b,"","")}}).fail(f.exception)}},v=function(b,c){var d=a("body");d.on(m.created,function(){n.reloadCurrentMonth(b)});d.on(m.deleted,function(){n.reloadCurrentMonth(b)});d.on(m.updated,function(){n.reloadCurrentMonth(b)});d.on(m.editActionEvent,function(a,b){window.location.assign(b)});d.on(m.moveEvent,u);d.on(m.eventMoved,function(){n.reloadCurrentMonth(b)});o.registerEditListeners(b,c)},w=function(b){b.on("click",q.VIEW_DAY_LINK,function(c){var d=a(c.target),e=d.data("year"),g=d.data("month"),h=d.data("day"),i=d.data("courseid"),j=d.data("categoryid");n.refreshDayContent(b,e,g,h,i,j,b,"core_calendar/calendar_day").then(function(){c.preventDefault();var a="?view=day&time="+d.data("timestamp");return window.history.pushState({},"",a)}).fail(f.exception)});b.on("change",p.elements.courseSelector,function(){var c=a(this),d=c.val();n.reloadCurrentMonth(b,d,null).then(function(){return b.find(p.elements.courseSelector).val(d)}).fail(f.exception)});var c=o.registerEventFormModal(b),d=a(q.CALENDAR_MONTH_WRAPPER).data("context-id");v(b,c);if(d){var e=document.querySelectorAll(q.CELL_ADD_EVENT_BUTTON_MONTH),g=document.querySelectorAll(q.CELL_ADD_EVENT_BUTTON_DAY),h=document.querySelector(q.ADD_EVENT_FORM_ADD_BUTTON),i=document.querySelector(q.EVENT_TYPES),j=document.querySelector(q.ADD_EVENT_FORM),k=j.querySelector(q.SELECT_COURSE_WRAPPER).querySelector(q.BACK_BUTTON_FROM_SELECT),m=j.querySelector(q.SELECT_GROUP_WRAPPER).querySelector(q.BACK_BUTTON_FROM_SELECT);if(e.length){Q(e)}if(g.length){Q(g)}if(i){i.addEventListener("click",R(i))}if(h){h.addEventListener("click",S)}if(k){k.addEventListener("click",T)}if(m){m.addEventListener("click",U)}b.on("click",q.DAY,function(a){if(a.target.closest(q.CELL_ADD_EVENT_BUTTON_MONTH)){return}var b=document.querySelector(q.CALENDAR_MONTH_WRAPPER),c=b.dataset;if(c.view&&"day"!==c.view){var d=a.target.closest("td"),e=d.dataset;sessionStorage.setItem(r,e.newEventTimestamp);l.getCalendarDayData(c.year,c.month,e.day,c.courseid,0).then(function(a){var b=a.events;if(b.length){var c=document.querySelector(q.SCHEDULE),d=c.querySelector(q.SCHEDULE_CONTENT),e=c.querySelector(q.SCHEDULE_ADD_EVENT_BUTTON);d.innerHTML="";var f=_createForOfIteratorHelper(b),g;try{for(f.s();!(g=f.n()).done;){var h=g.value,i="#fee7ae";console.log("EVENT",h);if(h.groupid){(function(){var a=h.groupid;document.querySelectorAll(q.LEGEND_GROUP).forEach(function(b){if(a===+b.dataset.groupId){i=b.querySelector(q.LEGEND_GROUP_COLOR).style.backgroundColor}})})()}var j=z(i),k=A(),l=B(),m=C(),n=D(i),o=E(i),p=F(),r=G(),s=1e3*h.timestart,t=1e3*(h.timestart+h.timeduration),u=H(s),v=H(t);p.append(u);r.append(v);o.append(p,r);l.append(h.popupname);k.append(l);if(h.description){m.append(h.description);k.append(m)}j.append(o,k);if(h.groupname){n.append(h.groupname);j.append(n)}if(h.canedit){j.classList.add("can-edit");j.addEventListener("click",L(h))}d.append(j)}}catch(a){f.e(a)}finally{f.f()}c.style.display="block";document.addEventListener("click",I);e.addEventListener("click",K)}}).catch(function(a){console.error("GET day data",a);alert("GET day data ERROR. Please, report administrator")})}})}},x=function(a){var b=document.createElement("div");b.className=a||"";return b},y=function(a,b){var c=x(a);for(var d in b){c.style.setProperty(d,b[d])}return c},z=function(a){return y("schedule-line",{borderColor:a,background:"#EFFAFF"})},A=function(){return x("schedule-event-content")},B=function(){return x("schedule-event-name")},C=function(){return x("schedule-event-description")},D=function(a){return y("schedule-event-group",{background:a})},E=function(a){return y("event-time",{background:a})},F=function(){return x("event-time-start")},G=function(){return x("event-time-end")},H=function(a){var b=function(a){return 10>a?"0"+a:a},c=new Date(a),d=b(c.getHours()),e=b(c.getMinutes());return"".concat(d,":").concat(e)},I=function(a){if(!a.target.closest(q.SCHEDULE)){document.querySelector(q.SCHEDULE).style.display="none";document.removeEventListener("click",I)}},J=function(a){var b=document.querySelector(q.ADD_EVENT_FORM),c=a.target.closest("td");if(c){sessionStorage.setItem(r,c.dataset.newEventTimestamp)}M(b);b.style.display="block";b.querySelectorAll("input[type=datetime-local]").forEach(function(a){var b=1e3*+sessionStorage.getItem(r),c=new Date(b).toJSON(),d=c.split(":");a.value="".concat(d[0],":").concat(d[1])});setTimeout(function(){document.addEventListener("click",O)},0)},K=function(a){document.querySelector(q.SCHEDULE).style.display="none";J(a)},L=function(a){return function(){var b=document.querySelector(q.ADD_EVENT_FORM),c=b.querySelector("input[name=name]"),d=b.querySelector(q.EVENT_TYPES),e=b.querySelector(q.SELECT_COURSE_WRAPPER),f=e.querySelector(q.SELECT_COURSE),g=b.querySelector(q.SELECT_GROUP_WRAPPER),h=g.querySelector(q.SELECT_GROUP),i=b.querySelector("input[name=time-start]"),j=b.querySelector("input[name=time-end]"),k=b.querySelector("textarea[name=description]"),l=b.querySelector("input[name=location]"),m=b.querySelector(q.ADD_EVENT_FORM_DELETE_BUTTON),n=new Date(1e3*a.timestart).toJSON().split(":"),o=new Date(1e3*(+a.timestart+ +a.timeduration)).toJSON().split(":"),p=document.createElement("option"),r=document.createElement("option");M(b);sessionStorage.setItem(t,a.id);sessionStorage.setItem(s,a.eventtype);c.value=a.name;i.value="".concat(n[0],":").concat(n[1]);j.value="".concat(o[0],":").concat(o[1]);if(a.description){k.value=a.description}if(a.location){l.value=a.location}d.querySelectorAll(q.EVENT_TYPE).forEach(function(b){if(b.dataset.eventType===a.eventtype){b.classList.add("active")}});if(a.course){var u=a.course;p.id=u.id;p.text=u.fullname;p.selected=!0;f.append(p)}if(a.groupid){r.id=a.groupid;r.text=a.groupname;r.selected=!0;h.append(r)}if(a.candelete){m.style.display="block"}b.style.display="block";setTimeout(function(){m.addEventListener("click",P);document.addEventListener("click",N)},0)}},M=function(a){var b=a.querySelector("input[name=name]"),c=a.querySelector(q.EVENT_TYPES),d=a.querySelector(q.SELECT_COURSE_WRAPPER),e=d.querySelector(q.SELECT_COURSE),f=a.querySelector(q.SELECT_GROUP_WRAPPER),g=f.querySelector(q.SELECT_GROUP),h=a.querySelector("textarea[name=description]"),i=a.querySelector("input[name=location]");b.value="";h.value="";i.value="";e.innerHTML="";g.innerHTML="";c.querySelectorAll(q.EVENT_TYPE).forEach(function(a){a.classList.remove("active")});f.style.display="none";d.style.display="none";c.style.display="flex"},N=function(a){if(!a.target.closest(q.ADD_EVENT_FORM)){sessionStorage.clear()}O(a)},O=function(a){if(!a.target.closest(q.ADD_EVENT_FORM)){document.querySelector(q.ADD_EVENT_FORM).style.display="none";document.removeEventListener("click",O);document.removeEventListener("click",N)}},P=function(){var a=sessionStorage.getItem(t);l.deleteEvent(a).then(function(){window.location.reload()}).catch(console.error)},Q=function(a){var b=_createForOfIteratorHelper(a),c;try{for(b.s();!(c=b.n()).done;){var d=c.value;d.addEventListener("click",J)}}catch(a){b.e(a)}finally{b.f()}},R=function(a){return function(b){var c=b.target.closest(q.EVENT_TYPE);if(c){var d=c.dataset.eventType;a.querySelectorAll(q.EVENT_TYPE).forEach(function(a){a.classList.remove("active")});c.classList.add("active");sessionStorage.setItem(s,d);switch(d){case"group":{document.querySelector(q.ADD_EVENT_FORM).querySelector(q.SELECT_COURSE_WRAPPER).querySelector(q.SELECT_COURSE).addEventListener("change",W)}case"course":{V()}}}}},S=function(){var a=document.querySelector(q.ADD_EVENT_FORM_DATA);if(a){var b=new FormData(a),c=new Date(b.get("time-start")),d=new Date(b.get("time-end")),e=b.get("name"),f=b.get("description"),g=b.get("location"),h=sessionStorage.getItem(s),i=sessionStorage.getItem(t);console.log("EVENT TYPE: ",h);if(!h){alert("Please, select event type");return}if(!e){alert("Please, type event name");return}var m={id:i||0,userid:0,modulename:"",instance:0,visible:1,mform_showmore_id_general:1,name:e,"timestart[year]":c.getFullYear(),"timestart[month]":c.getMonth()+1,"timestart[day]":c.getDate(),"timestart[hour]":c.getHours(),"timestart[minute]":c.getMinutes(),eventtype:h,"description[text]":f||"","description[format]":1,location:g};if(i){m._qf__core_calendar_local_event_forms_update=1}else{m._qf__core_calendar_local_event_forms_create=1}if(d-c){m.duration=1;m["timedurationuntil[year]"]=d.getFullYear();m["timedurationuntil[month]"]=d.getMonth()+1;m["timedurationuntil[day]"]=d.getDate();m["timedurationuntil[hour]"]=d.getHours();m["timedurationuntil[minute]"]=d.getMinutes()}else{m.duration=0}switch(h){case"group":{var j=b.get("courseId"),k=b.get("groupId");if(!j||"-1"===j){alert("Please, select group");return}if(!k||"-1"===k){alert("Please, select course");return}m.groupcourseid=j;m.groupid=k;break}case"course":{var n=b.get("courseId");if(!n||"-1"===n){alert("Please, select group");return}m.courseid=n;break}}var o="";for(var p in m){o+="".concat(p,"=").concat(m[p],"&")}o=encodeURI(o);sessionStorage.clear();l.submitCreateUpdateForm(o).then(function(){window.location.reload()}).catch(function(a){console.error(a)})}},T=function(a){var b=a.target.closest(q.SELECT_COURSE_WRAPPER);b.querySelector(q.SELECT_COURSE).removeEventListener("change",W);b.style.display="none";document.querySelector(q.EVENT_TYPES).style.display="flex"},U=function(a){var b=document.querySelector(q.SELECT_COURSE_WRAPPER);b.querySelector(q.SELECT_COURSE).addEventListener("change",W);a.target.closest(q.SELECT_GROUP_WRAPPER).style.display="none";b.style.display="flex"},V=function(){l.getUserCourses().then(function(a){var b=document.querySelector(q.ADD_EVENT_FORM),c=b.querySelector(q.SELECT_COURSE_WRAPPER),d=c.querySelector(q.SELECT_COURSE),e=b.querySelector(q.EVENT_TYPES);X(d);if(a.length){Y(d,a)}e.style.display="none";c.style.display="flex"}).catch(console.error)},W=function(a){var b=a.target.value;l.getCourseGroupsData(b).then(function(a){var b=document.querySelector(q.ADD_EVENT_FORM),c=b.querySelector(q.SELECT_COURSE_WRAPPER),d=b.querySelector(q.SELECT_GROUP_WRAPPER),e=c.querySelector(q.SELECT_COURSE),f=d.querySelector(q.SELECT_GROUP);X(f);e.removeEventListener("change",W);if(a.length){Y(f,a)}c.style.display="none";d.style.display="flex"}).catch(console.error)},X=function(a){var b=document.createElement("option");b.value="-1";b.text="...";a.innerHTML="";a.append(b)},Y=function(a,b){var c=_createForOfIteratorHelper(b),d;try{for(c.s();!(d=c.n()).done;){var e=d.value,f=document.createElement("option");f.value=e.id;f.text=e.name||e.fullname;a.append(f)}}catch(a){c.e(a)}finally{c.f()}};return{init:function init(b){b=a(b);n.init(b);w(b)}}});
//# sourceMappingURL=calendar.min.js.map
